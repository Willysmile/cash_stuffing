#!/bin/bash

# Script de lancement des serveurs Cash Stuffing
# Bisounours ğŸ»ğŸŒˆ

cd "$(dirname "$0")"

echo "ğŸ»ğŸŒˆ =================================="
echo "   BISOUNOURS - Cash Stuffing"
echo "=================================="
echo ""

# ArrÃªt des serveurs existants
echo "ğŸ” Recherche des processus uvicorn existants..."
EXISTING_PIDS=$(pgrep -f "uvicorn app.main:app")

if [ -n "$EXISTING_PIDS" ]; then
    echo "âš ï¸  Processus uvicorn trouvÃ©s: $EXISTING_PIDS"
    echo "ğŸ›‘ ArrÃªt des processus existants..."
    pkill -f "uvicorn app.main:app"
    sleep 1
    echo "âœ… Processus arrÃªtÃ©s"
else
    echo "âœ… Aucun processus uvicorn en cours"
fi
echo ""

# Lancement du backend
echo "ğŸš€ DÃ©marrage du serveur backend FastAPI..."
echo "ğŸ“‚ RÃ©pertoire: $(pwd)/backend"
cd backend
nohup ../venv/bin/uvicorn app.main:app --reload --host 127.0.0.1 --port 8000 > /tmp/uvicorn.log 2>&1 &
BACKEND_PID=$!
cd ..
sleep 1

# VÃ©rification que le serveur a dÃ©marrÃ©
if ps -p $BACKEND_PID > /dev/null; then
    echo "âœ… Backend dÃ©marrÃ© avec succÃ¨s (PID: $BACKEND_PID)"
else
    echo "âŒ Erreur lors du dÃ©marrage du backend"
    exit 1
fi

echo ""
echo "ğŸ‰ =================================="
echo "   SERVEURS DÃ‰MARRÃ‰S"
echo "=================================="
echo ""
echo "ğŸŒ URL Backend:  http://127.0.0.1:8000"
echo "ğŸ“– API Docs:     http://127.0.0.1:8000/docs"
echo "ğŸ”§ Frontend:     http://127.0.0.1:8000/"
echo ""
echo "ğŸ“‹ Logs backend: /tmp/uvicorn.log"
echo "ğŸ” Voir logs:    tail -f /tmp/uvicorn.log"
echo ""
echo "ğŸ›‘ Pour arrÃªter: kill $BACKEND_PID"
echo "   ou:           pkill -f 'uvicorn app.main:app'"
echo ""
