{% extends "base.html" %}

{% block title %}Dashboard - Cash Stuffing{% endblock %}

{% block content %}
<section class="hero is-light">
    <div class="hero-body">
        <p class="title">Dashboard</p>
        <p class="subtitle">Vue d'ensemble de vos finances</p>
    </div>
</section>

<div class="section">
    <!-- Stats et enveloppes -->
    <div hx-get="/api/dashboard/htmx/stats"
         hx-trigger="load"
         hx-swap="innerHTML">
        <div class="has-text-centered">
            <span class="icon is-large">
                <i class="fas fa-spinner fa-pulse fa-2x"></i>
            </span>
            <p>Chargement du dashboard...</p>
        </div>
    </div>

    <!-- Transactions récentes -->
    <div style="margin-top: 2rem;"
         hx-get="/api/dashboard/htmx/recent-transactions"
         hx-trigger="load"
         hx-swap="innerHTML">
        <div class="has-text-centered">
            <span class="icon is-large">
                <i class="fas fa-spinner fa-pulse fa-2x"></i>
            </span>
            <p>Chargement des transactions...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block title %}Tableau de bord - Cash Stuffing{% endblock %}

{% block content %}
<section class="hero is-info is-small">
    <div class="hero-body">
        <p class="title">Tableau de bord</p>
        <p class="subtitle">Bonjour <span id="userName"></span> !</p>
    </div>
</section>

<div class="section">
    <!-- Résumé financier -->
    <div class="columns is-multiline">
        <div class="column is-3">
            <div class="box has-text-centered">
                <p class="heading">Solde total</p>
                <p class="title is-4" id="totalBalance">0 €</p>
                <span class="icon has-text-success">
                    <i class="fas fa-wallet fa-2x"></i>
                </span>
            </div>
        </div>
        
        <div class="column is-3">
            <div class="box has-text-centered">
                <p class="heading">Enveloppes actives</p>
                <p class="title is-4" id="activeEnvelopes">0</p>
                <span class="icon has-text-primary">
                    <i class="fas fa-envelope fa-2x"></i>
                </span>
            </div>
        </div>
        
        <div class="column is-3">
            <div class="box has-text-centered">
                <p class="heading">Transactions ce mois</p>
                <p class="title is-4" id="monthlyTransactions">0</p>
                <span class="icon has-text-warning">
                    <i class="fas fa-exchange-alt fa-2x"></i>
                </span>
            </div>
        </div>
        
        <div class="column is-3">
            <div class="box has-text-centered">
                <p class="heading">Listes de souhaits</p>
                <p class="title is-4" id="wishListsCount">0</p>
                <span class="icon has-text-danger">
                    <i class="fas fa-gift fa-2x"></i>
                </span>
            </div>
        </div>
    </div>

    <!-- Graphiques -->
    <div class="columns">
        <div class="column is-8">
            <div class="box">
                <h2 class="title is-5">Répartition par catégorie</h2>
                <canvas id="categoryChart"></canvas>
            </div>
        </div>
        
        <div class="column is-4">
            <div class="box">
                <h2 class="title is-5">Répartition revenus/dépenses</h2>
                <canvas id="incomeExpenseChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Dernières transactions -->
    <div class="box">
        <h2 class="title is-5">
            <span class="icon-text">
                <span class="icon"><i class="fas fa-history"></i></span>
                <span>Transactions récentes</span>
            </span>
        </h2>
        <div id="recentTransactions">
            <div class="has-text-centered">
                <span class="icon is-large">
                    <i class="fas fa-spinner fa-pulse fa-2x"></i>
                </span>
                <p>Chargement...</p>
            </div>
        </div>
    </div>
</div>

<script>
// Configuration globale
const API_BASE = '/api';
// === MODE TEST : TOKEN FACTICE ===
const token = localStorage.getItem('access_token') || 'test-mode';
if (!localStorage.getItem('access_token')) {
    localStorage.setItem('access_token', 'test-mode');
}

// Vérification désactivée en mode test
// if (!token) {
//     window.location.href = '/auth/login';
// }

const headers = {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
};

// Fonction pour récupérer les données
async function fetchData(endpoint) {
    const response = await fetch(`${API_BASE}${endpoint}`, { headers });
    // Désactivé en mode test
    // if (response.status === 401) {
    //     localStorage.removeItem('access_token');
    //     window.location.href = '/auth/login';
    //     return null;
    // }
    return response.ok ? response.json() : null;
}

// Chargement des données du dashboard
async function loadDashboard() {
    try {
        // Informations utilisateur
        const user = await fetchData('/auth/me');
        if (user) {
            document.getElementById('userName').textContent = user.full_name || user.email;
        }

        // Statistiques des comptes bancaires
        const accounts = await fetchData('/bank_accounts');
        if (accounts) {
            const totalBalance = accounts.reduce((sum, acc) => sum + parseFloat(acc.balance || 0), 0);
            document.getElementById('totalBalance').textContent = `${totalBalance.toFixed(2)} €`;
        }

        // Statistiques des enveloppes
        const envelopes = await fetchData('/envelopes');
        if (envelopes) {
            document.getElementById('activeEnvelopes').textContent = envelopes.length;
        }

        // Statistiques des transactions
        const now = new Date();
        const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
        const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];
        const transactions = await fetchData(`/transactions?date_from=${firstDay}&date_to=${lastDay}`);
        if (transactions) {
            document.getElementById('monthlyTransactions').textContent = transactions.length;
            displayRecentTransactions(transactions.slice(0, 5));
        }

        // Statistiques des listes de souhaits
        const wishLists = await fetchData('/wish_lists');
        if (wishLists) {
            document.getElementById('wishListsCount').textContent = wishLists.length;
        }

        // Graphiques
        await loadCharts(transactions);
        
    } catch (error) {
        console.error('Erreur de chargement:', error);
    }
}

// Affichage des transactions récentes
function displayRecentTransactions(transactions) {
    const container = document.getElementById('recentTransactions');
    
    if (!transactions || transactions.length === 0) {
        container.innerHTML = '<p class="has-text-centered has-text-grey">Aucune transaction récente</p>';
        return;
    }
    
    const html = `
        <table class="table is-fullwidth is-hoverable">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Description</th>
                    <th>Catégorie</th>
                    <th class="has-text-right">Montant</th>
                </tr>
            </thead>
            <tbody>
                ${transactions.map(t => `
                    <tr>
                        <td>${new Date(t.date).toLocaleDateString('fr-FR')}</td>
                        <td>${t.description || '-'}</td>
                        <td>${t.category?.name || '-'}</td>
                        <td class="has-text-right ${t.type === 'income' ? 'has-text-success' : 'has-text-danger'}">
                            ${t.type === 'income' ? '+' : '-'}${parseFloat(t.amount).toFixed(2)} €
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
        <div class="has-text-centered">
            <a href="/transactions" class="button is-small is-link is-light">Voir toutes les transactions</a>
        </div>
    `;
    
    container.innerHTML = html;
}

// Chargement des graphiques
async function loadCharts(transactions) {
    if (!transactions || transactions.length === 0) return;
    
    // Graphique par catégorie
    const categories = await fetchData('/categories');
    if (categories) {
        const categoryData = {};
        categories.forEach(cat => categoryData[cat.name] = 0);
        
        transactions.forEach(t => {
            if (t.category) {
                categoryData[t.category.name] = (categoryData[t.category.name] || 0) + parseFloat(t.amount);
            }
        });
        
        new Chart(document.getElementById('categoryChart'), {
            type: 'bar',
            data: {
                labels: Object.keys(categoryData),
                datasets: [{
                    label: 'Montant (€)',
                    data: Object.values(categoryData),
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }
    
    // Graphique revenus/dépenses
    const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + parseFloat(t.amount), 0);
    const expense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + parseFloat(t.amount), 0);
    
    new Chart(document.getElementById('incomeExpenseChart'), {
        type: 'doughnut',
        data: {
            labels: ['Revenus', 'Dépenses'],
            datasets: [{
                data: [income, expense],
                backgroundColor: ['rgba(75, 192, 192, 0.5)', 'rgba(255, 99, 132, 0.5)'],
                borderColor: ['rgba(75, 192, 192, 1)', 'rgba(255, 99, 132, 1)'],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true
        }
    });
}

// Chargement initial
loadDashboard();
</script>
{% endblock %}
