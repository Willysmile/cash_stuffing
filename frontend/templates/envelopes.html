{% extends "base.html" %}

{% block title %}Enveloppes - Cash Stuffing{% endblock %}

{% block content %}
<section class="hero is-info">
    <div class="hero-body">
        <p class="title">Enveloppes budg√©taires</p>
        <p class="subtitle">Organisez vos budgets par enveloppe</p>
    </div>
</section>

<div class="section">
    <div class="level">
        <div class="level-left">
            <div class="level-item">
                <div class="field">
                    <div class="control has-icons-left">
                        <input class="input" type="text" id="searchInput" placeholder="Rechercher...">
                        <span class="icon is-left">
                            <i class="fas fa-search"></i>
                        </span>
                    </div>
                </div>
            </div>
        </div>
        <div class="level-right">
            <div class="level-item">
                <button class="button is-success" hx-get="/api/envelopes/htmx/create" hx-target="#modal-container" hx-swap="innerHTML">
                    <span class="icon"><i class="fas fa-plus"></i></span>
                    <span>Nouvelle enveloppe</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Conteneur pour charger les enveloppes via HTMX -->
    <div class="columns is-multiline" 
         id="envelopes-container"
         hx-get="/api/envelopes/htmx"
         hx-trigger="load"
         hx-swap="innerHTML">
        <div class="column is-12 has-text-centered">
            <span class="icon is-large">
                <i class="fas fa-spinner fa-pulse fa-2x"></i>
            </span>
            <p>Chargement des enveloppes...</p>
        </div>
    </div>
</div>

<script>
// Recherche en temps r√©el
document.getElementById('searchInput').addEventListener('input', (e) => {
    const query = e.target.value.toLowerCase();
    const cards = document.querySelectorAll('#envelopes-container .column');
    cards.forEach(card => {
        const title = card.textContent.toLowerCase();
        card.style.display = title.includes(query) ? '' : 'none';
    });
});
</script>
{% endblock %}
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title" id="modalTitle">Nouvelle enveloppe</p>
            <button class="delete" onclick="closeModal()"></button>
        </header>
        <section class="modal-card-body">
            <form id="envelopeForm">
                <input type="hidden" id="envelopeId">
                
                <div class="field">
                    <label class="label">Nom *</label>
                    <div class="control">
                        <input class="input" type="text" name="name" required>
                    </div>
                </div>

                <div class="field">
                    <label class="label">Compte bancaire</label>
                    <div class="control">
                        <div class="select is-fullwidth">
                            <select name="bank_account_id" id="modalAccountSelect">
                                <option value="">üíµ Esp√®ces (sans compte)</option>
                            </select>
                        </div>
                    </div>
                    <p class="help">Laissez vide pour une enveloppe en esp√®ces</p>
                </div>

                <div class="field">
                    <label class="label">Cat√©gorie *</label>
                    <div class="control">
                        <div class="select is-fullwidth">
                            <select name="category_id" id="modalCategorySelect" required>
                                <option value="">S√©lectionnez une cat√©gorie</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="field">
                    <label class="label">Objectif √† atteindre (‚Ç¨) *</label>
                    <div class="control has-icons-left">
                        <input class="input" type="number" step="0.01" min="0" name="target_amount" required>
                        <span class="icon is-left">
                            <i class="fas fa-bullseye"></i>
                        </span>
                    </div>
                    <p class="help">Montant total que vous souhaitez √©pargner</p>
                </div>

                <div class="field">
                    <label class="label">Description</label>
                    <div class="control">
                        <textarea class="textarea" name="description" rows="3" placeholder="Ex: Vacances d'√©t√© 2026"></textarea>
                    </div>
                </div>
            </form>
        </section>
        <footer class="modal-card-foot">
            <button class="button is-success" onclick="saveEnvelope()">Enregistrer</button>
            <button class="button" onclick="closeModal()">Annuler</button>
        </footer>
    </div>
</div>

<!-- Modal de r√©allocation -->
<div class="modal" id="reallocateModal">
    <div class="modal-background" onclick="closeReallocateModal()"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">R√©allouer des fonds</p>
            <button class="delete" onclick="closeReallocateModal()"></button>
        </header>
        <section class="modal-card-body">
            <form id="reallocateForm">
                <input type="hidden" id="fromEnvelopeId">
                
                <div class="field">
                    <label class="label">De : <span id="fromEnvelopeName"></span></label>
                    <p class="help">Budget disponible : <strong id="fromEnvelopeBudget">0 ‚Ç¨</strong></p>
                </div>

                <div class="field">
                    <label class="label">Vers l'enveloppe</label>
                    <div class="control">
                        <div class="select is-fullwidth">
                            <select id="toEnvelopeSelect" required>
                                <option value="">S√©lectionnez une enveloppe</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="field">
                    <label class="label">Montant (‚Ç¨)</label>
                    <div class="control has-icons-left">
                        <input class="input" type="number" step="0.01" min="0.01" id="reallocateAmount" required>
                        <span class="icon is-left">
                            <i class="fas fa-euro-sign"></i>
                        </span>
                    </div>
                </div>
            </form>
        </section>
        <footer class="modal-card-foot">
            <button class="button is-primary" onclick="reallocateFunds()">Transf√©rer</button>
            <button class="button" onclick="closeReallocateModal()">Annuler</button>
        </footer>
    </div>
</div>

<script>
const API_BASE = '/api';
// === MODE TEST : TOKEN FACTICE ===
const token = localStorage.getItem('access_token') || 'test-mode';
if (!localStorage.getItem('access_token')) {
    localStorage.setItem('access_token', 'test-mode');
}
const headers = { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' };

let envelopes = [];
let categories = [];
let accounts = [];

async function init() {
    await Promise.all([
        loadCategories(),
        loadAccounts()
    ]);
    await loadEnvelopes();
}

async function loadEnvelopes() {
    const response = await fetch(`${API_BASE}/envelopes`, { headers });
    if (response.ok) {
        envelopes = await response.json();
        console.log('Enveloppes charg√©es:', envelopes);
        console.log('Cat√©gories disponibles:', categories);
        console.log('Comptes disponibles:', accounts);
        
        // Enrichir les enveloppes avec les noms de cat√©gorie et compte
        envelopes.forEach(e => {
            if (e.category_id) {
                const category = categories.find(c => c.id === e.category_id);
                if (category) {
                    e.category = category;
                }
            }
            if (e.bank_account_id) {
                const account = accounts.find(a => a.id === e.bank_account_id);
                if (account) {
                    e.bank_account = account;
                }
            }
        });
        
        console.log('Enveloppes enrichies:', envelopes);
        displayEnvelopes(envelopes);
    }
}

async function loadCategories() {
    const response = await fetch(`${API_BASE}/categories`, { headers });
    if (response.ok) {
        categories = await response.json();
        populateSelect('modalCategorySelect', categories);
    }
}

async function loadAccounts() {
    const response = await fetch(`${API_BASE}/bank_accounts`, { headers });
    if (response.ok) {
        accounts = await response.json();
        populateSelect('modalAccountSelect', accounts);
    }
}

function populateSelect(selectId, items) {
    const select = document.getElementById(selectId);
    const currentOptions = select.querySelectorAll('option:not(:first-child)');
    currentOptions.forEach(opt => opt.remove());
    
    items.forEach(item => {
        const option = document.createElement('option');
        option.value = item.id;
        option.textContent = item.name;
        select.appendChild(option);
    });
}

function displayEnvelopes(data) {
    const container = document.getElementById('envelopesList');
    
    console.log('displayEnvelopes appel√© avec:', data);
    
    if (!data || data.length === 0) {
        container.innerHTML = '<div class="column is-12"><p class="has-text-centered has-text-grey">Aucune enveloppe</p></div>';
        return;
    }
    
    container.innerHTML = '';
    
    data.forEach(e => {
        console.log('Enveloppe:', e.name, 'objet complet:', e);
        const target = parseFloat(e.target_amount || 0);
        const current = parseFloat(e.current_balance || 0);
        const percentage = target > 0 ? (current / target) * 100 : 0;
        const bgClass = percentage >= 100 ? 'has-background-success' : percentage >= 75 ? 'has-background-info' : percentage >= 50 ? 'has-background-warning' : 'has-background-danger';
        const colorClass = percentage >= 100 ? 'is-success' : percentage >= 75 ? 'is-info' : percentage >= 50 ? 'is-warning' : 'is-danger';
        
        const html = `
            <div class="column is-4">
                <div class="card">
                    <header class="card-header ${bgClass}">
                        <p class="card-header-title has-text-white">
                            ${e.name}
                        </p>
                    </header>
                    <div class="card-content">
                        <div class="content">
                            <p><strong>Cat√©gorie:</strong> ${e.category?.name || '-'}</p>
                            <p><strong>Type:</strong> ${e.bank_account ? `üè¶ ${e.bank_account.name}` : 'üíµ Esp√®ces'}</p>
                            ${e.description ? `<p>${e.description}</p>` : ''}
                            
                            <div class="field">
                                <label class="label is-small">Progression</label>
                                <progress class="progress ${colorClass}" value="${percentage}" max="100">${percentage.toFixed(0)}%</progress>
                            </div>
                            
                            <div class="level is-mobile">
                                <div class="level-item has-text-centered">
                                    <div>
                                        <p class="heading">Objectif</p>
                                        <p class="title is-6">${target.toFixed(2)} ‚Ç¨</p>
                                    </div>
                                </div>
                                <div class="level-item has-text-centered">
                                    <div>
                                        <p class="heading">√âpargn√©</p>
                                        <p class="title is-6">${current.toFixed(2)} ‚Ç¨</p>
                                    </div>
                                </div>
                                <div class="level-item has-text-centered">
                                    <div>
                                        <p class="heading">Restant</p>
                                        <p class="title is-6">${(target - current).toFixed(2)} ‚Ç¨</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <footer class="card-footer">
                        <a class="card-footer-item" onclick="editEnvelope(${e.id})">
                            <span class="icon"><i class="fas fa-edit"></i></span>
                            <span>Modifier</span>
                        </a>
                        <a class="card-footer-item" onclick="showReallocateModal(${e.id})">
                            <span class="icon"><i class="fas fa-exchange-alt"></i></span>
                            <span>R√©allouer</span>
                        </a>
                        <a class="card-footer-item has-text-danger" onclick="deleteEnvelope(${e.id})">
                            <span class="icon"><i class="fas fa-trash"></i></span>
                            <span>Supprimer</span>
                        </a>
                    </footer>
                </div>
            </div>
        `;
        
        container.insertAdjacentHTML('beforeend', html);
    });
}

function showAddModal() {
    document.getElementById('modalTitle').textContent = 'Nouvelle enveloppe';
    document.getElementById('envelopeForm').reset();
    document.getElementById('envelopeId').value = '';
    document.getElementById('envelopeModal').classList.add('is-active');
}

async function editEnvelope(id) {
    const envelope = envelopes.find(e => e.id === id);
    if (!envelope) return;
    
    document.getElementById('modalTitle').textContent = 'Modifier l\'enveloppe';
    document.getElementById('envelopeId').value = envelope.id;
    document.querySelector('[name="name"]').value = envelope.name;
    document.querySelector('[name="bank_account_id"]').value = envelope.bank_account_id;
    document.querySelector('[name="category_id"]').value = envelope.category_id;
    document.querySelector('[name="target_amount"]').value = envelope.target_amount || 0;
    document.querySelector('[name="description"]').value = envelope.description || '';
    
    document.getElementById('envelopeModal').classList.add('is-active');
}

async function saveEnvelope() {
    const form = document.getElementById('envelopeForm');
    const formData = new FormData(form);
    const id = document.getElementById('envelopeId').value;
    
    const data = {
        name: formData.get('name'),
        bank_account_id: formData.get('bank_account_id') ? parseInt(formData.get('bank_account_id')) : null,
        category_id: formData.get('category_id') ? parseInt(formData.get('category_id')) : null,
        target_amount: parseFloat(formData.get('target_amount')) || 0,
        description: formData.get('description') || null
    };
    
    const url = id ? `${API_BASE}/envelopes/${id}` : `${API_BASE}/envelopes`;
    const method = id ? 'PUT' : 'POST';
    
    const response = await fetch(url, {
        method,
        headers,
        body: JSON.stringify(data)
    });
    
    if (response.ok) {
        closeModal();
        await loadEnvelopes();
    } else {
        const error = await response.json();
        alert('Erreur: ' + (error.detail || '√âchec de la sauvegarde'));
    }
}

async function deleteEnvelope(id) {
    if (!confirm('Voulez-vous vraiment supprimer cette enveloppe ?')) return;
    
    const response = await fetch(`${API_BASE}/envelopes/${id}`, {
        method: 'DELETE',
        headers
    });
    
    if (response.ok) {
        await loadEnvelopes();
    } else {
        alert('Erreur lors de la suppression');
    }
}

function showReallocateModal(fromId) {
    const envelope = envelopes.find(e => e.id === fromId);
    if (!envelope) return;
    
    document.getElementById('fromEnvelopeId').value = fromId;
    document.getElementById('fromEnvelopeName').textContent = envelope.name;
    document.getElementById('fromEnvelopeBudget').textContent = `${parseFloat(envelope.current_balance || 0).toFixed(2)} ‚Ç¨`;
    
    // Peupler la liste des enveloppes destinations (exclure celle de d√©part)
    const toSelect = document.getElementById('toEnvelopeSelect');
    toSelect.innerHTML = '<option value="">S√©lectionnez une enveloppe</option>';
    envelopes.filter(e => e.id !== fromId).forEach(e => {
        const option = document.createElement('option');
        option.value = e.id;
        option.textContent = e.name;
        toSelect.appendChild(option);
    });
    
    document.getElementById('reallocateModal').classList.add('is-active');
}

async function reallocateFunds() {
    const fromId = document.getElementById('fromEnvelopeId').value;
    const toId = document.getElementById('toEnvelopeSelect').value;
    const amount = parseFloat(document.getElementById('reallocateAmount').value);
    
    if (!toId || !amount) {
        alert('Veuillez remplir tous les champs');
        return;
    }
    
    const response = await fetch(`${API_BASE}/envelopes/${fromId}/reallocate`, {
        method: 'POST',
        headers,
        body: JSON.stringify({
            to_envelope_id: parseInt(toId),
            amount: amount
        })
    });
    
    if (response.ok) {
        closeReallocateModal();
        await loadEnvelopes();
    } else {
        const error = await response.json();
        alert('Erreur: ' + (error.detail || '√âchec de la r√©allocation'));
    }
}

function closeModal() {
    document.getElementById('envelopeModal').classList.remove('is-active');
}

function closeReallocateModal() {
    document.getElementById('reallocateModal').classList.remove('is-active');
    document.getElementById('reallocateForm').reset();
}

// Recherche
document.addEventListener('DOMContentLoaded', () => {
    init();
    document.getElementById('searchInput').addEventListener('input', (e) => {
        const search = e.target.value.toLowerCase();
        const filtered = search ? envelopes.filter(env =>
            env.name.toLowerCase().includes(search) ||
            (env.description || '').toLowerCase().includes(search)
        ) : envelopes;
        displayEnvelopes(filtered);
    });
});
</script>
{% endblock %}
