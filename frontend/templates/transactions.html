{% extends "base.html" %}

{% block title %}Transactions - Cash Stuffing{% endblock %}

{% block content %}
<section class="hero is-primary">
    <div class="hero-body">
        <p class="title">Transactions</p>
        <p class="subtitle">Gérez toutes vos transactions</p>
    </div>
</section>

<div class="section">
    <!-- Onglets par compte -->
    <div class="tabs is-boxed is-medium" id="accountTabs">
        <ul id="accountTabsList">
        </ul>
    </div>
    <div class="columns">
        <div class="column is-3">
            <!-- Filtres -->
            <div class="box">
                <h2 class="title is-5">Filtres</h2>
                
                <div class="field">
                    <label class="label">Type</label>
                    <div class="control">
                        <div class="select is-fullwidth">
                            <select id="filterType">
                                <option value="">Tous</option>
                                <option value="income">Revenus</option>
                                <option value="expense">Dépenses</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="field">
                    <label class="label">Date de début</label>
                    <div class="control">
                        <input class="input" type="date" id="filterDateFrom">
                    </div>
                </div>

                <div class="field">
                    <label class="label">Date de fin</label>
                    <div class="control">
                        <input class="input" type="date" id="filterDateTo">
                    </div>
                </div>

                <div class="field">
                    <label class="label">Catégorie</label>
                    <div class="control">
                        <div class="select is-fullwidth">
                            <select id="filterCategory">
                                <option value="">Toutes</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="field">
                    <div class="control">
                        <button class="button is-primary is-fullwidth" onclick="applyFilters()">
                            <span class="icon"><i class="fas fa-filter"></i></span>
                            <span>Appliquer</span>
                        </button>
                    </div>
                </div>

                <div class="field">
                    <div class="control">
                        <button class="button is-light is-fullwidth" onclick="resetFilters()">
                            <span class="icon"><i class="fas fa-redo"></i></span>
                            <span>Réinitialiser</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="column is-9">
            <!-- En-tête avec bouton d'ajout -->
            <div class="level">
                <div class="level-left">
                    <div class="level-item">
                        <div class="field has-addons">
                            <div class="control has-icons-left">
                                <input class="input" type="text" id="searchInput" placeholder="Rechercher...">
                                <span class="icon is-left">
                                    <i class="fas fa-search"></i>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="level-right">
                    <div class="level-item">
                        <button class="button is-success" onclick="showAddModal()">
                            <span class="icon"><i class="fas fa-plus"></i></span>
                            <span>Nouvelle transaction</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Liste des transactions -->
            <div class="box">
                <div id="transactionsList">
                    <div class="has-text-centered">
                        <span class="icon is-large">
                            <i class="fas fa-spinner fa-pulse fa-2x"></i>
                        </span>
                        <p>Chargement...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal d'ajout/édition -->
<div class="modal" id="transactionModal">
    <div class="modal-background" onclick="closeModal()"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title" id="modalTitle">Nouvelle transaction</p>
            <button class="delete" onclick="closeModal()"></button>
        </header>
        <section class="modal-card-body">
            <form id="transactionForm">
                <input type="hidden" id="transactionId">
                
                <div class="field">
                    <label class="label">Type *</label>
                    <div class="control">
                        <label class="radio">
                            <input type="radio" name="type" value="income" required>
                            Revenu
                        </label>
                        <label class="radio">
                            <input type="radio" name="type" value="expense" required checked>
                            Dépense
                        </label>
                    </div>
                </div>

                <div class="field">
                    <label class="label">Montant * (€)</label>
                    <div class="control has-icons-left">
                        <input class="input" type="number" step="0.01" min="0.01" name="amount" required>
                        <span class="icon is-left">
                            <i class="fas fa-euro-sign"></i>
                        </span>
                    </div>
                </div>

                <div class="field">
                    <label class="label">Date *</label>
                    <div class="control">
                        <input class="input" type="date" name="date" required>
                    </div>
                </div>

                <div class="field">
                    <label class="label">Compte bancaire *</label>
                    <div class="control">
                        <div class="select is-fullwidth">
                            <select name="bank_account_id" id="modalAccountSelect" required>
                                <option value="">Sélectionnez un compte</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="field">
                    <label class="label">Catégorie *</label>
                    <div class="control">
                        <div class="select is-fullwidth">
                            <select name="category_id" id="modalCategorySelect" required>
                                <option value="">Sélectionnez une catégorie</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="field">
                    <label class="label">Bénéficiaire</label>
                    <div class="control has-icons-left">
                        <div class="select is-fullwidth">
                            <select name="payee_id" id="modalPayeeSelect">
                                <option value="">Aucun</option>
                            </select>
                        </div>
                        <span class="icon is-left">
                            <i class="fas fa-user"></i>
                        </span>
                    </div>
                </div>

                <div class="field">
                    <label class="label">Description</label>
                    <div class="control">
                        <textarea class="textarea" name="description" rows="3"></textarea>
                    </div>
                </div>
            </form>
        </section>
        <footer class="modal-card-foot">
            <button class="button is-success" onclick="saveTransaction()">Enregistrer</button>
            <button class="button" onclick="closeModal()">Annuler</button>
        </footer>
    </div>
</div>

<script>
const API_BASE = '/api';
// === MODE TEST : TOKEN FACTICE ===
const token = localStorage.getItem('access_token') || 'test-mode';
if (!localStorage.getItem('access_token')) {
    localStorage.setItem('access_token', 'test-mode');
}
const headers = { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' };

let transactions = [];
let categories = [];
let accounts = [];
let payees = [];
let currentAccountFilter = null; // Filtre actif par compte

// Chargement initial
async function init() {
    await Promise.all([
        loadTransactions(),
        loadCategories(),
        loadAccounts(),
        loadPayees()
    ]);
    
    // Set date d'aujourd'hui par défaut
    document.querySelector('[name="date"]').value = new Date().toISOString().split('T')[0];
}

async function loadTransactions() {
    let url = `${API_BASE}/transactions`;
    if (currentAccountFilter) {
        url += `?bank_account_id=${currentAccountFilter}`;
    }
    const response = await fetch(url, { headers });
    if (response.ok) {
        transactions = await response.json();
        
        // Enrichir les transactions avec les noms de catégorie et compte
        transactions.forEach(t => {
            const category = categories.find(c => c.id === t.category_id);
            const account = accounts.find(a => a.id === t.bank_account_id);
            const payee = payees.find(p => p.id === t.payee_id);
            
            t.category = category;
            t.bank_account = account;
            t.payee = payee;
        });
        
        displayTransactions(transactions);
    }
}

async function loadCategories() {
    const response = await fetch(`${API_BASE}/categories`, { headers });
    if (response.ok) {
        categories = await response.json();
        populateSelect('filterCategory', categories);
        populateSelect('modalCategorySelect', categories);
    }
}

async function loadAccounts() {
    const response = await fetch(`${API_BASE}/bank_accounts`, { headers });
    if (response.ok) {
        accounts = await response.json();
        displayAccountTabs(accounts);
        populateSelect('modalAccountSelect', accounts);
    }
}


async function loadPayees() {
    const response = await fetch(`${API_BASE}/payees`, { headers });
    if (response.ok) {
        payees = await response.json();
        populateSelect('modalPayeeSelect', payees);
    }
}

function populateSelect(selectId, items) {
    const select = document.getElementById(selectId);
    const isFilter = selectId.startsWith('filter');
    const currentOptions = select.querySelectorAll('option:not(:first-child)');
    currentOptions.forEach(opt => opt.remove());
    
    items.forEach(item => {
        const option = document.createElement('option');
        option.value = item.id;
        option.textContent = item.name;
        select.appendChild(option);
    });
}

function displayAccountTabs(accountsList) {
    const tabsList = document.getElementById('accountTabsList');
    
    // Vider la liste
    tabsList.innerHTML = '';
    
    // Ajouter un onglet par compte
    accountsList.forEach((account, index) => {
        const li = document.createElement('li');
        li.setAttribute('data-account', account.id);
        if (index === 0) li.classList.add('is-active'); // Premier onglet actif par défaut
        
        const balance = parseFloat(account.current_balance || 0).toFixed(2);
        const icon = account.icon || 'fa-university';
        
        li.innerHTML = `
            <a onclick="selectAccountTab(${account.id})">
                <span class="icon"><i class="fas ${icon}"></i></span>
                <span>${account.name}</span>
                <span class="tag is-info is-light ml-2">${balance} €</span>
            </a>
        `;
        
        tabsList.appendChild(li);
    });
    
    // Sélectionner le premier compte par défaut
    if (accountsList.length > 0) {
        selectAccountTab(accountsList[0].id);
    }
}

function selectAccountTab(accountId) {
    // Mettre à jour l'onglet actif visuellement
    const tabs = document.querySelectorAll('#accountTabsList li');
    tabs.forEach(tab => {
        if (tab.getAttribute('data-account') == accountId) {
            tab.classList.add('is-active');
        } else {
            tab.classList.remove('is-active');
        }
    });
    
    // Mettre à jour le filtre et recharger
    currentAccountFilter = accountId;
    loadTransactions();
}

function displayTransactions(data) {
    const container = document.getElementById('transactionsList');
    
    if (!data || data.length === 0) {
        container.innerHTML = '<p class="has-text-centered has-text-grey">Aucune transaction</p>';
        return;
    }
    
    const html = `
        <table class="table is-fullwidth is-hoverable is-striped">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Description</th>
                    <th>Type</th>
                    <th>Catégorie</th>
                    <th>Sous-catégorie</th>
                    <th class="has-text-right">Montant</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                ${data.map(t => `
                    <tr>
                        <td>${new Date(t.date).toLocaleDateString('fr-FR')}</td>
                        <td>${t.description || '-'}</td>
                        <td>
                            <span class="tag ${t.transaction_type === 'income' ? 'is-success' : 'is-danger'}">
                                ${t.transaction_type === 'income' ? 'Revenu' : 'Dépense'}
                            </span>
                        </td>
                        <td>${t.category?.parent ? t.category.parent.name : (t.category?.name || '-')}</td>
                        <td>${t.category?.parent ? t.category.name : '-'}</td>
                        <td class="has-text-right ${t.transaction_type === 'income' ? 'has-text-success' : 'has-text-danger'}">
                            ${t.transaction_type === 'income' ? '+' : '-'}${parseFloat(t.amount).toFixed(2)} €
                        </td>
                        <td>
                            <div class="buttons are-small">
                                <button class="button is-info is-light" onclick="editTransaction(${t.id})">
                                    <span class="icon"><i class="fas fa-edit"></i></span>
                                </button>
                                <button class="button is-danger is-light" onclick="deleteTransaction(${t.id})">
                                    <span class="icon"><i class="fas fa-trash"></i></span>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
    
    container.innerHTML = html;
}

function showAddModal() {
    document.getElementById('modalTitle').textContent = 'Nouvelle transaction';
    document.getElementById('transactionForm').reset();
    document.getElementById('transactionId').value = '';
    document.querySelector('[name="date"]').value = new Date().toISOString().split('T')[0];
    
    // Pré-sélectionner le compte de l'onglet actif si un filtre est actif
    if (currentAccountFilter) {
        document.querySelector('[name="bank_account_id"]').value = currentAccountFilter;
    }
    
    document.getElementById('transactionModal').classList.add('is-active');
}

async function editTransaction(id) {
    const transaction = transactions.find(t => t.id === id);
    if (!transaction) return;
    
    document.getElementById('modalTitle').textContent = 'Modifier la transaction';
    document.getElementById('transactionId').value = transaction.id;
    document.querySelector('[name="type"][value="' + transaction.transaction_type + '"]').checked = true;
    document.querySelector('[name="amount"]').value = transaction.amount;
    document.querySelector('[name="date"]').value = transaction.date;
    document.querySelector('[name="bank_account_id"]').value = transaction.bank_account_id;
    document.querySelector('[name="category_id"]').value = transaction.category_id;
    document.querySelector('[name="envelope_id"]').value = transaction.envelope_id || '';
    document.querySelector('[name="description"]').value = transaction.description || '';
    document.querySelector('[name="payee_id"]').value = transaction.payee_id || '';
    
    document.getElementById('transactionModal').classList.add('is-active');
}

async function saveTransaction() {
    const form = document.getElementById('transactionForm');
    const formData = new FormData(form);
    const id = document.getElementById('transactionId').value;
    
    // Validation
    if (!formData.get('type')) {
        alert('Veuillez sélectionner un type de transaction');
        return;
    }
    if (!formData.get('amount') || isNaN(parseFloat(formData.get('amount')))) {
        alert('Veuillez saisir un montant valide');
        return;
    }
    if (!formData.get('date')) {
        alert('Veuillez saisir une date');
        return;
    }
    if (!formData.get('bank_account_id')) {
        alert('Veuillez sélectionner un compte bancaire');
        return;
    }
    if (!formData.get('category_id')) {
        alert('Veuillez sélectionner une catégorie');
        return;
    }
    
    const data = {
        transaction_type: formData.get('type'),
        amount: parseFloat(formData.get('amount')),
        date: formData.get('date'),
        bank_account_id: parseInt(formData.get('bank_account_id')),
        category_id: parseInt(formData.get('category_id')),
        description: formData.get('description') || null,
        payee_id: formData.get('payee_id') ? parseInt(formData.get('payee_id')) : null,
        priority: null,
        is_recurring: false
    };
    
    const url = id ? `${API_BASE}/transactions/${id}` : `${API_BASE}/transactions`;
    const method = id ? 'PUT' : 'POST';
    
    const response = await fetch(url, {
        method,
        headers,
        body: JSON.stringify(data)
    });
    
    if (response.ok) {
        closeModal();
        await loadTransactions();
    } else {
        const error = await response.json();
        alert('Erreur: ' + (error.detail || 'Échec de la sauvegarde'));
    }
}

async function deleteTransaction(id) {
    if (!confirm('Voulez-vous vraiment supprimer cette transaction ?')) return;
    
    const response = await fetch(`${API_BASE}/transactions/${id}`, {
        method: 'DELETE',
        headers
    });
    
    if (response.ok) {
        await loadTransactions();
    } else {
        alert('Erreur lors de la suppression');
    }
}

function closeModal() {
    document.getElementById('transactionModal').classList.remove('is-active');
}

function applyFilters() {
    let filtered = [...transactions];
    
    const type = document.getElementById('filterType').value;
    const dateFrom = document.getElementById('filterDateFrom').value;
    const dateTo = document.getElementById('filterDateTo').value;
    const categoryId = document.getElementById('filterCategory').value;
    const search = document.getElementById('searchInput').value.toLowerCase();
    
    if (type) filtered = filtered.filter(t => t.transaction_type === type);
    if (dateFrom) filtered = filtered.filter(t => t.date >= dateFrom);
    if (dateTo) filtered = filtered.filter(t => t.date <= dateTo);
    if (categoryId) filtered = filtered.filter(t => t.category_id == categoryId);
    if (search) filtered = filtered.filter(t => 
        (t.description || '').toLowerCase().includes(search) ||
        (t.payee || '').toLowerCase().includes(search)
    );
    
    displayTransactions(filtered);
}

function resetFilters() {
    document.getElementById('filterType').value = '';
    document.getElementById('filterDateFrom').value = '';
    document.getElementById('filterDateTo').value = '';
    document.getElementById('filterCategory').value = '';
    document.getElementById('searchInput').value = '';
    displayTransactions(transactions);
}

// Recherche en temps réel
document.addEventListener('DOMContentLoaded', () => {
    init();
    document.getElementById('searchInput').addEventListener('input', applyFilters);
});
</script>
{% endblock %}
